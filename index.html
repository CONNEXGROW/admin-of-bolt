<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolt Appointments | Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... existing styles ... */

        /* Delete Button Styles */
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .delete-btn i {
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Bolt Appointments</h1>
                <p>Admin Panel for the Appointments</p>
            </div>

            <div class="dropdown" id="navDropdown">
                <button class="dropdown-btn" onclick="toggleDropdown()">
                    <i class="fas fa-bars"></i> Navigation
                </button>
                <div class="dropdown-content">
                    <a href="uplord.html"><i class="fas fa-link"></i> Uplords</a>
                    <a href="testimonials.html"><i class="fas fa-star"></i> Testimonials</a>
                    <a href="job.html"><i class="fas fa-briefcase"></i> Career</a>
                    <a href="appointments.html"><i class="fas fa-calendar-check"></i> Appointments</a>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="login-section">
                <p>Please login to access the appointment details</p>
                <button id="login-button"><i class="fab fa-google"></i> Login with Google</button>
            </div>

            <div class="table-container">
                <table id="thesis-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Appointment Date</th>
                            <th>Appointment Time</th>
                            <th>Phone Number</th>
                            <th>Message</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here -->
                    </tbody>
                </table>

                <div id="empty-state" class="empty-state">
                    <i class="far fa-calendar-alt"></i>
                    <p>Login to view appointment details</p>
                </div>

                <div id="loading" class="loading">
                    <i class="fas fa-spinner"></i>
                </div>
            </div>
        </div>

        <div class="footer">
            &copy; 2025 Bolt Appointments | All Rights Reserved
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAkDl3ckFSXDHlZpyR0s7IZ1UTSX8Z6hSY",
            authDomain: "bolt-54408.firebaseapp.com",
            projectId: "bolt-54408",
            storageBucket: "bolt-54408.firebasestorage.app",
            messagingSenderId: "88291790006",
            appId: "1:88291790006:web:259387f2de1d7b164eaa17",
            measurementId: "G-6YD4D3514J"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // DOM elements
        const loginButton = document.getElementById('login-button');
        const thesisTable = document.getElementById('thesis-table');
        const tableBody = thesisTable.querySelector('tbody');
        const emptyState = document.getElementById('empty-state');
        const loading = document.getElementById('loading');
        const navDropdown = document.getElementById('navDropdown');

        // Toggle dropdown function
        function toggleDropdown() {
            navDropdown.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        window.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-btn') && !event.target.closest('.dropdown-btn')) {
                navDropdown.classList.remove('active');
            }
        });

        // Hide table initially, show empty state
        thesisTable.style.display = 'none';
        emptyState.style.display = 'block';

        // Google login
        loginButton.addEventListener('click', () => {
            loading.style.display = 'block';
            emptyState.style.display = 'none';

            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider)
                .then(result => {
                    loginButton.innerHTML = '<i class="fas fa-check-circle"></i> Logged In';
                    loginButton.disabled = true;
                    loginButton.style.backgroundColor = '#4cc9f0';

                    const idToken = result.user.getIdToken();
                    idToken.then(token => {
                        fetch('https://bolt-hmik.onrender.com/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ idToken: token })
                        })
                        .then(response => response.json())
                        .then(data => {
                            console.log('Login successful:', data);
                            fetchThesisDetails(token);
                        })
                        .catch(error => {
                            console.error('Error logging in:', error);
                            showError('Login failed. Please try again.');
                        });
                    });
                })
                .catch(error => {
                    console.error('Error during Google login:', error);
                    showError('Google login failed. Please try again.');
                });
        });

        // Fetch thesis details with authentication
        const fetchThesisDetails = (token) => {
            loading.style.display = 'block';

            fetch('https://bolt-hmik.onrender.com/thesis-details', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                return response.json();
            })
            .then(data => {
                loading.style.display = 'none';

                if (data && data.length > 0) {
                    thesisTable.style.display = 'table';
                    emptyState.style.display = 'none';

                    // Clear existing rows
                    tableBody.innerHTML = '';

                    // Add data rows
                    data.forEach((item, index) => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-id', item.id); // Assuming each item has a unique ID
                        row.innerHTML = `
                            <td>${escapeHtml(item.name || '-')}</td>
                            <td>${escapeHtml(item.email || '-')}</td>
                            <td>${escapeHtml(item.appointmentDate || '-')}</td>
                            <td>${escapeHtml(item.appointmentTime || '-')}</td>
                            <td>${escapeHtml(item.phone || '-')}</td>
                            <td>${escapeHtml(item.message || '-')}</td>
                            <td>
                                <button class="delete-btn" onclick="deleteAppointment('${item.id}', '${token}')">
                                    <i class="fas fa-trash-alt"></i> Delete
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    // No data
                    thesisTable.style.display = 'none';
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <i class="far fa-calendar-times"></i>
                        <p>No appointment data available</p>
                    `;
                }
            })
            .catch(error => {
                console.error('Error fetching thesis details:', error);
                loading.style.display = 'none';
                showError('Failed to fetch appointment data');
            });
        };

        // Helper function to show errors
        const showError = (message) => {
            loading.style.display = 'none';
            emptyState.style.display = 'block';
            emptyState.innerHTML = `
                <i class="fas fa-exclamation-circle" style="color: #dc3545;"></i>
                <p>${message}</p>
            `;
        };

        // Helper function to escape HTML to prevent XSS
        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        // Check if user is already logged in
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                loginButton.innerHTML = '<i class="fas fa-check-circle"></i> Logged In';
                loginButton.disabled = true;
                loginButton.style.backgroundColor = '#4cc9f0';

                user.getIdToken().then(token => {
                    fetchThesisDetails(token);
                });
            }
        });

        // Delete appointment function
        const deleteAppointment = (appointmentId, token) => {
            if (confirm('Are you sure you want to delete this appointment? This action is not reversible.')) {
                loading.style.display = 'block';

                fetch(`https://bolt-hmik.onrender.com/appointments/${appointmentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to delete appointment');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Appointment deleted:', data);
                    loading.style.display = 'none';

                    // Remove the row from the table
                    const row = document.querySelector(`tr[data-id="${appointmentId}"]`);
                    if (row) {
                        row.remove();
                    }

                    // Check if the table is empty after deletion
                    if (tableBody.rows.length === 0) {
                        thesisTable.style.display = 'none';
                        emptyState.style.display = 'block';
                        emptyState.innerHTML = `
                            <i class="far fa-calendar-times"></i>
                            <p>No appointment data available</p>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error deleting appointment:', error);
                    loading.style.display = 'none';
                    showError('Failed to delete appointment');
                });
            }
        };
    </script>
</body>
</html>
